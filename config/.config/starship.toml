format = """
$directory\
$custom\
$character"""

[directory]
truncation_length = 3
truncate_to_repo = false
format = "[$path]($style) "
style = "bold blue"

[character]
success_symbol = "\n[❯](bold green)"
error_symbol = "\n[❯](bold red)"

# Branch: green if clean, yellow if dirty
[custom.branch_clean]
command = "git branch --show-current"
when = "git rev-parse --git-dir 2>/dev/null && git diff --quiet 2>/dev/null && git diff --cached --quiet 2>/dev/null"
format = "[$output]($style)\n"
style = "bold green"

[custom.branch_dirty]
command = "git branch --show-current"
when = "git rev-parse --git-dir 2>/dev/null && ! (git diff --quiet 2>/dev/null && git diff --cached --quiet 2>/dev/null)"
format = "[$output]($style)\n"
style = "bold yellow"

# Context line: ssh | env | db
[custom.context]
command = '''
out=""

# SSH indicator
if [ -n "$SSH_CONNECTION" ]; then
  out="ssh: $(hostname -s)"
fi

# Get APP_ENV (cascade)
env=""
if [ -n "$APP_ENV" ]; then
  env="$APP_ENV"
elif grep -q '^APP_ENV=' .env.local 2>/dev/null; then
  env=$(grep '^APP_ENV=' .env.local | cut -d= -f2)
elif grep -q '^APP_ENV=' .env.test.local 2>/dev/null; then
  env=$(grep '^APP_ENV=' .env.test.local | cut -d= -f2)
elif grep -q '^APP_ENV=' .env 2>/dev/null; then
  env=$(grep '^APP_ENV=' .env | cut -d= -f2)
fi

if [ -n "$env" ]; then
  [ -n "$out" ] && out="$out | "
  out="${out}env: $env"
fi

# Get database name - handle quotes and optional query string
db=""
dbline=""
if [ -f .env.local ] && grep -q '^DATABASE_URL=' .env.local; then
  dbline=$(grep '^DATABASE_URL=' .env.local | head -1)
elif [ -f .env ] && grep -q '^DATABASE_URL=' .env; then
  dbline=$(grep '^DATABASE_URL=' .env | head -1)
fi

if [ -n "$dbline" ]; then
  # Remove DATABASE_URL= prefix, quotes, and extract db name
  db=$(echo "$dbline" | sed 's/^DATABASE_URL=//' | tr -d '"' | sed -E 's|.*[/@]([^?/@]+)(\?.*)?$|\1|')
fi

# Resolve parameters
if [ -n "$db" ]; then
  db=$(echo "$db" | sed "s/%kernel.environment%/$env/g")

  # Resolve ${GIT_BRANCH}
  if echo "$db" | grep -q 'GIT_BRANCH'; then
    branch=$(git branch --show-current 2>/dev/null || echo "")
    db=$(echo "$db" | sed "s/\${GIT_BRANCH}/$branch/g")
  fi

  [ -n "$out" ] && out="$out | "
  out="${out}db: $db"
fi

echo "$out"
'''
when = "test -f .env -o -f .env.local -o -n \"$SSH_CONNECTION\""
format = "[$output]($style)"
style = "dimmed white"

# Xdebug indicator
[custom.xdebug]
command = "echo ' | xdebug'"
when = "test -n \"$XDEBUG_SESSION\""
format = "[$output]($style)"
style = "bold red"
