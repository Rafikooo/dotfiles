format = """
$directory\
$custom\
$character"""

[directory]
truncation_length = 3
truncate_to_repo = false
format = "[$path]($style) "
style = "bold blue"

[character]
success_symbol = "\n[❯](bold green)"
error_symbol = "\n[❯](bold red)"

# Branch: green if clean, yellow if dirty
[custom.branch_clean]
command = "git branch --show-current"
when = "git rev-parse --git-dir 2>/dev/null && git diff --quiet 2>/dev/null && git diff --cached --quiet 2>/dev/null"
format = "[$output]($style)\n"
style = "bold green"

[custom.branch_dirty]
command = "git branch --show-current"
when = "git rev-parse --git-dir 2>/dev/null && ! (git diff --quiet 2>/dev/null && git diff --cached --quiet 2>/dev/null)"
format = "[$output]($style)\n"
style = "bold yellow"

# Context line: serve | ssh | env | db
[custom.context]
command = '''
out=""

# Symfony server indicator (fast file-based check)
pidfile=$(grep -l "\"dir\": \"$PWD\"" ~/.symfony5/var/*/*.pid 2>/dev/null | head -1)
if [ -n "$pidfile" ]; then
  pid=$(grep -o '"pid": [0-9]*' "$pidfile" | grep -o '[0-9]*')
  if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
    # Get domain from proxy.json (extract key from line containing this path)
    domain=$(grep "\"$PWD\"" ~/.symfony5/proxy.json 2>/dev/null | sed -E 's/.*"([^"]+)":.*/\1/')
    if [ -n "$domain" ]; then
      url="https://${domain}.wip"
      out=$(printf 'server: \033]8;;%s\007%s\033]8;;\007' "$url" "${domain}.wip")
    else
      out="server"
    fi
  fi
fi

# Docker compose indicator (fast: filter by dir name)
if [ -f docker-compose.yml ] || [ -f docker-compose.yaml ] || [ -f compose.yml ] || [ -f compose.yaml ]; then
  project=$(basename "$PWD" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-')
  ports=$(docker ps --filter "name=$project" --format '{{.Ports}}' 2>/dev/null)
  if [ -n "$ports" ]; then
    [ -n "$out" ] && out="$out | "
    # Try to find web port (80, 443, 8080, 8000)
    webport=$(echo "$ports" | grep -oE '0\.0\.0\.0:([0-9]+)->(80|443|8080|8000)/' | head -1 | sed 's/0\.0\.0\.0:\([0-9]*\).*/\1/')
    if [ -n "$webport" ]; then
      url="http://localhost:$webport"
      [ "$webport" = "443" ] && url="https://localhost"
      [ "$webport" = "80" ] && url="http://localhost"
      out="${out}$(printf 'docker: \033]8;;%s\007localhost:%s\033]8;;\007' "$url" "$webport")"
    else
      out="${out}docker"
    fi
  fi
fi

# SSH indicator
if [ -n "$SSH_CONNECTION" ]; then
  [ -n "$out" ] && out="$out | "
  out="${out}ssh: $(hostname -s)"
fi

# Screen indicator
if [ -n "$STY" ]; then
  [ -n "$out" ] && out="$out | "
  out="${out}screen"
fi

# Get APP_ENV (cascade)
env=""
if [ -n "$APP_ENV" ]; then
  env="$APP_ENV"
elif grep -q '^APP_ENV=' .env.local 2>/dev/null; then
  env=$(grep '^APP_ENV=' .env.local | cut -d= -f2)
elif grep -q '^APP_ENV=' .env.test.local 2>/dev/null; then
  env=$(grep '^APP_ENV=' .env.test.local | cut -d= -f2)
elif grep -q '^APP_ENV=' .env 2>/dev/null; then
  env=$(grep '^APP_ENV=' .env | cut -d= -f2)
fi

if [ -n "$env" ]; then
  [ -n "$out" ] && out="$out | "
  out="${out}env: $env"
fi

# Get database info
db=""
dbtype=""
dbhost=""
dbline=""
if [ -f .env.local ] && grep -q '^DATABASE_URL=' .env.local; then
  dbline=$(grep '^DATABASE_URL=' .env.local | head -1)
elif [ -f .env ] && grep -q '^DATABASE_URL=' .env; then
  dbline=$(grep '^DATABASE_URL=' .env | head -1)
fi

if [ -n "$dbline" ]; then
  # Extract db type (mysql/pgsql/postgresql)
  dbtype=$(echo "$dbline" | sed -E 's/.*=["'"'"']?(mysql|pgsql|postgresql).*/\1/' | head -1)
  [ "$dbtype" = "postgresql" ] && dbtype="pgsql"

  # Extract host
  dbhost=$(echo "$dbline" | tr -d '"' | sed -E 's/.*@([^:/]+).*/\1/')

  # Extract db name
  db=$(echo "$dbline" | sed 's/^DATABASE_URL=//' | tr -d '"' | sed -E 's|.*[/@]([^?/@]+)(\?.*)?$|\1|')
fi

# Resolve parameters
if [ -n "$db" ]; then
  db=$(echo "$db" | sed "s/%kernel.environment%/$env/g")

  # Resolve ${GIT_BRANCH}
  if echo "$db" | grep -q 'GIT_BRANCH'; then
    branch=$(git branch --show-current 2>/dev/null || echo "")
    db=$(echo "$db" | sed "s/\${GIT_BRANCH}/$branch/g")
  fi

  [ -n "$out" ] && out="$out | "

  # Show: type/dbname or docker:type/dbname
  if [ "$dbhost" != "127.0.0.1" ] && [ "$dbhost" != "localhost" ]; then
    out="${out}db: ${dbhost}:${dbtype}/${db}"
  else
    out="${out}db: ${dbtype}/${db}"
  fi
fi

echo "$out"
'''
when = "test -f .env -o -f .env.local -o -n \"$SSH_CONNECTION\" -o -n \"$STY\""
format = "[$output]($style)"
style = "dimmed white"

# Xdebug indicator
[custom.xdebug]
command = "echo ' | xdebug'"
when = "test -n \"$XDEBUG_SESSION\""
format = "[$output]($style)"
style = "bold red"
