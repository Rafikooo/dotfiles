# Git
wip() {
    git add .
    git commit -m "WIP"
}

gcrb() {
    [[ -z "$1" ]] && { echo "Commit hash missing"; return 1; }

    git commit --fixup=$1

    local stash_created=0
    if [[ -n "$(git status --porcelain)" ]]; then
        git stash push --keep-index -m "Stashing changes before rebase"
        stash_created=1
    fi

    GIT_SEQUENCE_EDITOR=true git rebase -i --autosquash $1^

    [[ "$stash_created" -eq 1 ]] && git stash pop
}

tagandrelease() {
    git tag -a "$1" -m "$1" && git push upstream "$1" && gh release create "$1" --generate-notes
}

untagandunrelease() {
    gh release delete "$1" --yes && git push upstream --delete "$1" && git tag -d "$1"
}

glb() {
    local branch
    branch=$(git lb | fzf --ansi --height 20 --reverse | awk '{print $NF}')
    [[ -n "$branch" ]] && git checkout "$branch"
}

# Symfony
ss() {
    APP_ENV=${1:-dev} symfony serve -d
}

sss() {
    symfony server:stop
}

cc() {
    if [[ -d "var" ]]; then
        rm -fr var/cache
        php -dxdebug.mode=off symfony console
    elif [[ -d "tests/Application" ]]; then
        cd tests/Application && rm -fr var/cache && symfony console
    else
        echo "Wrong directory"
    fi
}

dbc() {
    rm -fr private/invoices/*
    bin/console doctrine:database:drop --force --if-exists
    bin/console doctrine:database:create
    bin/console doctrine:migrations:migrate -n
    bin/console sylius:fixtures:load $1 -n
}

dbct() {
    bin/console doctrine:database:create --if-not-exists --env=test
    bin/console doctrine:schema:update --force --env=test
}

# Yarn
uberyarn() {
    rm -fr node_modules/.cache public/build
    yarn install
    yarn build
}

# Reset project
cofankolite() {
    git restore --staged .
    git restore .
    git clean -fd
}

cofanko() {
    cofankolite
    composer update
    bin/console doctrine:database:drop --if-exists --force
    bin/console doctrine:database:create --if-not-exists
    bin/console doctrine:migrations:migrate -n
}

# Xdebug
phpstorm() {
    export XDEBUG_SESSION_START=phpstorm
    export XDEBUG_CONFIG="idkey=PHPSTORM"
    export XDEBUG_SESSION=xdebug_is_great
}

xdebugoff() {
    unset XDEBUG_SESSION_START
    unset XDEBUG_CONFIG
    unset XDEBUG_SESSION
}

# Interactive env selector
setenv() {
    local env=$(echo -e "dev\ntest\nprod" | fzf --height=5 --prompt="APP_ENV: ")
    if [ -n "$env" ]; then
        export APP_ENV="$env"
        echo "APP_ENV=$env"
    fi
}

# Clear env (use .env defaults)
clearenv() {
    unset APP_ENV
    echo "APP_ENV cleared (using .env defaults)"
}

# Interactive database name change in .env.local
setdb() {
    [[ ! -f .env.local ]] && { echo "No .env.local found"; return 1; }

    local current=$(grep '^DATABASE_URL=' .env.local | head -1)
    echo "Current: $current"
    echo ""

    read "newdb?New database name (or empty to cancel): "
    [[ -z "$newdb" ]] && { echo "Cancelled"; return 0; }

    # Get current URL structure, replace db name
    local prefix=$(echo "$current" | sed -E 's|(DATABASE_URL=.*/)([^?]+)(.*)|\1|')
    local suffix=$(echo "$current" | sed -E 's|(DATABASE_URL=.*/)([^?]+)(.*)|\3|')

    local newline="${prefix}${newdb}${suffix}"

    # Replace in .env.local
    sed -i '' "s|^DATABASE_URL=.*|$newline|" .env.local

    echo "Updated: $newline"
}

# Update dotfiles from remote
dotupdate() {
    echo "Updating dotfiles..."
    cd ~/.dotfiles && git pull

    # Restow all (in case new files added)
    stow -R zsh vim git config bash 2>/dev/null

    # Reload
    source ~/.zshrc
    echo "Done! Dotfiles updated and reloaded."
}
